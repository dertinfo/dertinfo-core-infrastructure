# Pipeline for deploying changes to the APIM instance

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/**
pr:
  branches:
    exclude:
      - '*'

name: Deploy_APIM_Integration_Infrastructure

variables:
  - group: DertInfoAPIMIntegration_VariablesGroup
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: location
    value: 'uksouth'
  - name: templateFile
    value: '**/apim/main.bicep'
  - name: csmParametersFile
    value: '**/apim/main.parameters.json'

stages:
  - stage: Validate
    jobs:
      - job: Validate_Deployment
        pool:
          vmImage: $(vmImageName)
        steps:
          - script: |
              echo Build.SourceBranch: $(Build.SourceBranch)
              echo The Build.Reason: $(Build.Reason)
              echo The Build.ArtifactStagingDirectory: $(Build.ArtifactStagingDirectory)
              echo The Build.BuildNumber: $(Build.BuildNumber)
              echo SubscriptionReference_Stg: $(SubscriptionReference_Stg)
              echo SubscriptionReference_Prod: $(SubscriptionReference_Prod)
              echo ResourceGroupName_Stg: $(ResourceGroupName_Stg)
              echo ResourceGroupName_Prod: $(ResourceGroupName_Prod)
              echo location: $(location)
              echo templateFile: $(templateFile)
              echo csmParametersFile: $(csmParametersFile)
              echo OwnerInitials: $(OwnerInitials)
              echo WorkloadName: $(WorkloadName)
              echo ApplicationInsightsName_Stg: $(ApplicationInsightsName_Stg)
              echo ApplicationInsightsName_Prod: $(ApplicationInsightsName_Prod)
              echo ApplicationInsightsResourceGroupName_Stg: $(ApplicationInsightsResourceGroupName_Stg)
              echo ApplicationInsightsResourceGroupName_Prod: $(ApplicationInsightsResourceGroupName_Prod)
              echo EnvironmentTag_Stg: $(EnvironmentTag_Stg)
              echo EnvironmentTag_Prod: $(EnvironmentTag_Prod)
              echo PublisherEmail: $(PublisherEmail)
              echo PublisherName: $(PublisherName)
            displayName: 'Output build variables'
            
  - stage: Test
    displayName: Deploy to Test
    jobs:
      - job: Deploy_To_Test
        pool:
          vmImage: $(vmImageName)
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            azureResourceManagerConnection: '$(SubscriptionReference_Stg)'
            deploymentScope: 'Resource Group'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(ResourceGroupName_Stg)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: '$(templateFile)'
            csmParametersFile: '$(csmParametersFile)'
            deploymentMode: 'Incremental'
            deploymentName: 'Deploy-Integration-APIM' 
            overrideParameters: |
              -ownerInitials $(OwnerInitials) \
              -workloadName $(WorkloadName) \
              -applicationInsightsName $(ApplicationInsightsName_Stg) \
              -applicationInsightsResourceGroupName $(ApplicationInsightsResourceGroupName_Stg) \
              -environmentTag $(EnvironmentTag_Stg) \
              -publisherEmail $(PublisherEmail) \
              -publisherName $(PublisherName)

  - stage: Live
    displayName: Deploy to Live
    dependsOn: Test
    jobs:
      - job: Deploy_To_Live
        pool:
          vmImage: $(vmImageName)
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            azureResourceManagerConnection: $(SubscriptionReference_Prod)
            deploymentScope: 'Resource Group'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(ResourceGroupName_Prod)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: '$(templateFile)'
            csmParametersFile: '$(csmParametersFile)'
            deploymentMode: 'Incremental'
            deploymentName: 'Deploy-Integration-APIM' 
            overrideParameters: |
              -ownerInitials $(OwnerInitials) \
              -workloadName $(WorkloadName) \
              -applicationInsightsName $(ApplicationInsightsName_Prod) \
              -applicationInsightsResourceGroupName $(ApplicationInsightsResourceGroupName_Prod) \
              -environmentTag $(EnvironmentTag_Prod) \
              -publisherEmail $(PublisherEmail) \
              -publisherName $(PublisherName)


# Pipeline for deploying changes to the APIM instance

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/**
pr:
  branches:
    exclude:
      - '*'

name: Deploy APIM Integration Infrastructure

variables:
  - group: DertInfoAPIMIntegration_VariablesGroup
  vmImageName: 'ubuntu-latest'
  location: uksouth
  templateFile: './main.bicep'
  csmParametersFile: './main.parameters.json'

stages:
  - stage: Test
    displayName: Deploy to Test
    jobs:
      - job: Create Resource Group & Deploy (Staging)
        pool:
          vmImage: vmImageName
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Resource Group'
            azureSubscription: '$(SubscriptionReference_Stg)'
            action: 'Create Or Update Resource Group (Staging)'
            resourceGroupName: '$(ResourceGroupName_Stg)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: '$(templateFile)'
            csmParametersFile: '$(csmParametersFile)'
            deploymentMode: 'Incremental'
            deploymentName: 'Deploy Integration APIM' 
            overrideParameters: |
              -ownerInitials $(OwnerInitials) \
              -workloadName $(WorkloadName) \
              -applicationInsightsName $(ApplicationInsightsName_Stg) \
              -applicationInsightsResourceGroupName $(ApplicationInsightsResourceGroupName_Stg) \
              -environmentTag $(EnvironmentTag_Stg) \
              -publisherEmail $(PublisherEmail) \
              -publisherName $(PublisherName)

  - stage: Live
    displayName: Deploy to Live
    dependsOn: Test
    jobs:
      - job: Create Resource Group & Deploy (Production)
        pool:
          vmImage: vmImageName
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Resource Group'
            azureSubscription: '$(SubscriptionReference_Prod)'
            action: 'Create Or Update Resource Group (Production)'
            resourceGroupName: '$(ResourceGroupName_Prod)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: '$(templateFile)'
            csmParametersFile: '$(csmParametersFile)'
            deploymentMode: 'Incremental'
            deploymentName: 'Deploy Integration APIM' 
            overrideParameters: |
              -ownerInitials $(OwnerInitials) \
              -workloadName $(WorkloadName) \
              -applicationInsightsName $(ApplicationInsightsName_Prod) \
              -applicationInsightsResourceGroupName $(ApplicationInsightsResourceGroupName_Prod) \
              -environmentTag $(EnvironmentTag_Prod) \
              -publisherEmail $(PublisherEmail) \
              -publisherName $(PublisherName)

